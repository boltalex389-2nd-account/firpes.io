<!DOCTYPE html>
<html>
	<head>

		<meta charset="utf-8" />

		<link rel="icon" 
			  type="image/gif" 
			  href="assets/misc/imp.gif" />

		<title>Game</title>

		<style type="text/css" media="screen">
		body{
			margin: 0px;
			overflow: hidden;
			text-align: center;
		}

		#a{
			text-align: center;
			position: absolute;
			top: 50%;
			left: 0px;
			width: 100%;
			height: 1px;
			overflow: visible;
			visibility: visible;
			display: block
		}

		#b{
			margin-left: -30px;
			position: absolute;
			top: -30px;
			left: 50%;
			width: 60px;
			height: 60px;
			visibility: visible
		}
		</style>
	</head>
	<body>
		<!-- preloader -->
		<div id="a"><img id="b" height="60" width="60" alt="Loading..." src="assets/misc/loading.gif"></div>

		<!-- 1.10.2 because https://twitter.com/makc3d/status/475039125914271744 -->
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
		<script src="scripts/loaders.js"></script>

		<!-- r67 -->
		<script src="http://rawgit.com/mrdoob/three.js/a083e4442732f076e85446ca42e5f7a829b7d28b/build/three.js"></script>
		<script src="scripts/misc3d.js"></script>

		<script src="scripts/ecs.js"></script>

		<script>
		// load game assets
		// http://css-tricks.com/multiple-simultaneous-ajax-requests-one-callback-jquery/
		$.when(
			 $.loadImage("assets/skybox/Side1.jpg")
			,$.loadImage("assets/skybox/Side2.jpg")
			,$.loadImage("assets/skybox/Side3.jpg")
			,$.loadImage("assets/skybox/Side4.jpg")
			,$.loadImage("assets/skybox/Side5.jpg")
			,$.loadImage("assets/skybox/Side6.jpg")
			,$.getJSON("assets/arena/arena.json")
			,$.loadImage("assets/arena/arena.jpg")
			,$.getJSON("assets/shotgun/hud/Dreadus-Shotgun.json")
			,$.loadImage("assets/shotgun/hud/Dreadus-Shotgun.jpg")
		).then(function(
			 skyboxSide1
			,skyboxSide2
			,skyboxSide3
			,skyboxSide4
			,skyboxSide5
			,skyboxSide6
			,arenaModel
			,arenaTexture
			,shotgunModel
			,shotgunTexture
		){
			// set up keyboard controls

			var keys = { SP: 32, W: 87, A: 65, S: 83, D: 68, UP: 38, LT: 37, DN: 40, RT: 39 };

			var keysPressed = {};

			(function(watchedKeyCodes) {
				var handler = function(down) {
					return function(e) {
						var index = watchedKeyCodes.indexOf(e.keyCode);
						if (index >= 0) {
							keysPressed[watchedKeyCodes[index]] = down; e.preventDefault();
						}
					};
				}
				$(document).keydown(handler(true));
				$(document).keyup(handler(false));
			})([
				keys.SP, keys.W, keys.A, keys.S, keys.D, keys.UP, keys.LT, keys.DN, keys.RT
			]);


			// create various 3D stuff

			game.scene.add(new SkyBox([
				skyboxSide3, skyboxSide5, skyboxSide6, skyboxSide1, skyboxSide2, skyboxSide4
			], 1400));

			arenaModel = new StaticMD2Model(arenaModel[0], arenaTexture);
			arenaModel.material.map.anisotropy = game.maxAnisotropy;
			game.scene.add(arenaModel);

			shotgunModel = new AnimatedMD2Model(shotgunModel[0], shotgunTexture);
			shotgunModel.rotation.x = -0.7; // hide
			shotgunModel.rotation.y = -Math.PI / 2;
			shotgunModel.position.x = 0.235; // center
			shotgunModel.position.y = -0.2; // take less space on screen
			game.camera.add(shotgunModel);


			// add 3D scene to the webpage

			$("body").empty().append(game.domElement);
			var gameViewportSize = function() { return {
				width: window.innerWidth, height: window.innerHeight
			}};


			// define components

			function Hero() {
				// all the properties unique to our hero shall go here
			};

			function Body(object, height) {
				// 3d object representing our entity
				this.object = object;
				// its height above the platform
				this.height = height || 0;
			};

			function Motion(px, py, pz, vx, vy, vz, rx, ry, sx, sy) {
				// basic entity motion information
				this.airborne = false;
				this.position = new THREE.Vector3(px || 0, py || 0, pz || 0);
				this.velocity = new THREE.Vector3(vx || 0, vy || 0, vz || 0);
				this.rotation = new THREE.Vector2(rx || 0, ry || 0);
				this.spinning = new THREE.Vector2(sx || 0, sy || 0);
			};


			// create entities

			new ecs.Entity()
				.add(new Hero())
				.add(new Body(game.camera, 1.0))
				.add(new Motion(-2, 7.7, 25));


			// game systems code

			var keyboardControls = (function() {
				var forward = new THREE.Vector3();
				var sideways = new THREE.Vector3();

				return function(dt) {
					ecs.for_each([Hero, Motion], function(player) {
						var motion = player.get(Motion);
						if(!motion.airborne) {

							// look around
							var sx = keysPressed[keys.UP] ? 0.04 : (keysPressed[keys.DN] ? -0.04 : 0);
							var sy = keysPressed[keys.LT] ? 0.04 : (keysPressed[keys.RT] ? -0.04 : 0);

							if(Math.abs(sx) >= Math.abs(motion.spinning.x)) motion.spinning.x = sx;
							if(Math.abs(sy) >= Math.abs(motion.spinning.y)) motion.spinning.y = sy;

							// move around
							// calculate forward direction in the horizontal plane from rotation
							forward.set(Math.sin(motion.rotation.y), 0, Math.cos(motion.rotation.y));
							// calculate sideways direction from forward direction
							sideways.set(forward.z, 0, -forward.x);

							forward.multiplyScalar(keysPressed[keys.W] ? -0.1 : (keysPressed[keys.S] ? 0.1 : 0));
							sideways.multiplyScalar(keysPressed[keys.A] ? -0.1 : (keysPressed[keys.D] ? 0.1 : 0));

							var combined = forward.add(sideways);
							if(Math.abs(combined.x) >= Math.abs(motion.velocity.x)) motion.velocity.x = combined.x;
							if(Math.abs(combined.y) >= Math.abs(motion.velocity.y)) motion.velocity.y = combined.y;
							if(Math.abs(combined.z) >= Math.abs(motion.velocity.z)) motion.velocity.z = combined.z;

						}
					});
				};
			})();

			var applyPhysics = (function() {
				var timeStep = 5;
				var timeLeft = timeStep + 1;

				var birdsEye = 100;
				var kneeDeep = 0.4;

				var raycaster = new THREE.Raycaster();
				raycaster.ray.direction.set(0, -1, 0);

				var angles = new THREE.Vector2();
				var displacement = new THREE.Vector3();

				return function(dt) {
					timeLeft += dt;

					// run several fixed-step iterations to approximate varying-step

					dt = 5;
					while(timeLeft >= dt) {

						ecs.for_each([Motion], function(entity) {
							// implement very simple platformer physics
							var time = 0.3, damping = 0.93;

							var motion = entity.get(Motion);

							raycaster.ray.origin.copy(motion.position);
							raycaster.ray.origin.y += birdsEye;
							var hits = raycaster.intersectObject(arenaModel);


							motion.airborne = true;
							// are we above, or at most knee deep in, the platform?
							if((hits.length > 0) && (hits[0].face.normal.y > 0)) {
								var actualHeight = hits[0].distance - birdsEye;
								// collision: stick to the surface if landing on it
								if((motion.velocity.y <= 0) && (Math.abs(actualHeight) < kneeDeep)) {
									motion.position.y -= actualHeight;
									motion.velocity.y = 0;
									motion.airborne = false;
								}
							}

							if(motion.airborne) {
								// free fall: apply the gravity
								motion.velocity.y -= 0.01;
							}


							angles.copy(motion.spinning).multiplyScalar(time);
							if(!motion.airborne) motion.spinning.multiplyScalar(damping);

							displacement.copy(motion.velocity).multiplyScalar(time);
							if(!motion.airborne) motion.velocity.multiplyScalar(damping);

							motion.rotation.add(angles);
							motion.position.add(displacement);

							// limit the tilt at ±0.4 radians
							motion.rotation.x = Math.max(-0.4, Math.min (0.4, motion.rotation.x));
							// wrap horizontal rotation to 0...2π
							motion.rotation.y += 2 * Math.PI; motion.rotation.y %= 2 * Math.PI;
						});

						timeLeft -= dt;
					}
				};
			})();

			var renderBodies = (function() {
				var euler = new THREE.Euler(0, 0, 0, 'YXZ');

				return function(dt) {
					ecs.for_each([Body, Motion], function(entity) {
						var body = entity.get(Body);
						var motion = entity.get(Motion);

						euler.x = motion.rotation.x;
						euler.y = motion.rotation.y;
						body.object.quaternion.setFromEuler(euler);

						body.object.position.copy(motion.position);

						body.object.position.y += body.height;
					});
				};
			})();

			var resetHero = function(dt) {
				// temorary system to bring our hero back on the platform
				ecs.for_each([Hero, Motion], function(player) {
					var motion = player.get(Motion);
					if(motion.position.y < -123) {
						motion.position.set(-2, 7.7, 25);
						motion.velocity.multiplyScalar(0);
					}
				});
			};


			// start the game

			var gameLoop = function(dt) {

				resetHero(dt);
				keyboardControls(dt);
				applyPhysics(dt);
				renderBodies(dt);

			};

			game.start(gameLoop, gameViewportSize);

		}).fail(function(err, msg) {
			console.log(err, msg);
		});
		</script>
	</body>
</html>